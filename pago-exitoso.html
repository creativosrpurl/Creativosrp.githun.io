<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Pago Exitoso! - Creativos RP</title>
  <link rel="icon" href="logos/logo-gta-san-andreas.jpg" type="image/jpeg">

  <!-- Fuentes y estilos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- Librer√≠a para generar la imagen del comprobante -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kDXrdZEo8NNYCKaYHNssg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* Estilos espec√≠ficos para esta p√°gina de √©xito */
    .success-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 2rem;
    }
    .success-box {
      max-width: 600px;
    }
    .success-box .gta-section-title {
        color: #32CD32; /* Verde para √©xito */
        text-shadow: 0 0 8px rgba(50, 205, 50, 0.5);
    }
    .receipt-table {
      width: 100%;
      margin-top: 1.5rem; /* Reducido */
      text-align: left;
      border-collapse: collapse;
    }
    .receipt-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #444;
      color: #fff;
    }
    .receipt-table td:first-child {
      color: #FFD700;
      font-weight: bold;
    }
    .receipt-table tr:last-child td {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div id="gta-bg" aria-hidden="true"></div>

  <main class="success-container">
    <div class="success-box gta-section">
      <h1 class="gta-section-title">¬°Transacci√≥n Aprobada!</h1>
      <p class="gta-text" style="margin-bottom: 1rem;">
        Gracias por tu compra, <strong id="display-username">jugador</strong>. Para recibir tus Coins, por favor sigue estos pasos:
      </p>

      <!-- Tabla de detalles de la compra -->
      <table class="receipt-table">
        <tbody>
          <tr><td>Usuario SA-MP:</td><td id="receipt-username">--</td></tr>
          <tr><td>Producto:</td><td id="receipt-item">--</td></tr>
          <tr><td>Monto Pagado:</td><td id="receipt-amount">--</td></tr>
          <tr><td>Fecha del Pago:</td><td id="receipt-date">--</td></tr>
          <tr>
            <td>ID de Transacci√≥n:</td>
            <td style="display: flex; justify-content: space-between; align-items: center;">
              <span id="receipt-orderID">--</span>
              <button id="copy-order-id-btn" class="gta-boton-copiar" style="display: none;">Copiar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <p class="gta-text" style="text-align: left; display: inline-block; margin-top: 1rem; font-size: 0.9em;">
        1. Toma una <strong>captura de pantalla</strong> de esta p√°gina o del correo de confirmaci√≥n de PayPal.<br>
        2. √önete a nuestro Discord y abre un ticket.<br>
        3. Env√≠a la captura al Staff para que validen tu compra y te entreguen los Coins en el juego.
      </p>
      <div class="gta-button-group">
        <button id="download-receipt-btn" class="gta-boton">Descargar Comprobante</button>
        <a href="https://discord.gg/EsgBcUCubQ" target="_blank" class="gta-boton">Ir a Discord</a>
        <a href="index.html" class="gta-boton">Volver al Inicio</a>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Carga la imagen de fondo din√°micamente, igual que en index.html
      const bgElement = document.getElementById('gta-bg');
      if (bgElement) {
        const bgImageUrl = 'https://wallpaperaccess.in/public/uploads/preview/cool-gta-san-andreas-wallpaper-1920x1080.jpg';
        bgElement.style.backgroundImage = `url(${bgImageUrl})`;
        bgElement.style.opacity = '0.4';
      }

      const successBox = document.querySelector('.success-box');
      const urlParams = new URLSearchParams(window.location.search);
      
      // Extraemos todos los datos de la URL
      const username = urlParams.get('username');
      const itemName = urlParams.get('itemName');
      const amount = urlParams.get('amount');
      const currency = urlParams.get('currency');
      const dateStr = urlParams.get('date');
      const orderID = urlParams.get('orderID');

      // ¬°NUEVO! Enviar notificaci√≥n al backend en cuanto se carga la p√°gina.
      // Esto es seguro porque solo se ejecuta despu√©s de un pago real.
      const IS_LOCAL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      // üõë Pega aqu√≠ la URL que te dar√° Render en el Paso 3.
      const RENDER_URL = 'https://creativos-rp-server.onrender.com'; 
      const API_URL = IS_LOCAL ? 'http://localhost:3000' : RENDER_URL;

      fetch(`${API_URL}/log-purchase`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          itemName: itemName,
          amount: amount,
          currency: currency,
          orderID: orderID
        })
      }).catch(error => {
        console.error('No se pudo enviar la notificaci√≥n de compra al servidor:', error);
        // No es un error cr√≠tico para el usuario, por lo que no mostramos alerta.
      });

      // Mostramos los datos en la p√°gina
      document.getElementById('display-username').textContent = username || 'jugador';
      document.getElementById('receipt-username').textContent = username || 'No especificado';
      document.getElementById('receipt-item').textContent = itemName || 'No especificado';
      if (amount && currency) {
        // Formateamos el monto seg√∫n la moneda recibida
        const formatOptions = {
          style: 'currency',
          currency: currency,
          minimumFractionDigits: currency === 'COP' ? 0 : 2
        };
        const locale = currency === 'COP' ? 'es-CO' : 'en-US';
        document.getElementById('receipt-amount').textContent = new Intl.NumberFormat(locale, formatOptions).format(amount);
      } else {
        document.getElementById('receipt-amount').textContent = 'No especificado';
      }
      document.getElementById('receipt-orderID').textContent = orderID || 'No especificado';

      if (dateStr) {
        // Formateamos la fecha para que sea m√°s legible
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('receipt-date').textContent = date.toLocaleDateString('es-ES', options);
      } else {
        document.getElementById('receipt-date').textContent = 'No especificado';
      }
      
      // L√≥gica para el bot√≥n de copiar ID de transacci√≥n
      const copyBtn = document.getElementById('copy-order-id-btn');
      if (orderID) {
        copyBtn.style.display = 'inline-block'; // Muestra el bot√≥n si hay un ID
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(orderID).then(() => {
            copyBtn.textContent = '¬°Copiado!';
            setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 2000);
          }).catch(() => alert('Error al copiar el ID.'));
        });
      }
      
      // L√≥gica para descargar el comprobante
      const downloadBtn = document.getElementById('download-receipt-btn');
      downloadBtn.addEventListener('click', () => {
        downloadBtn.textContent = 'Generando imagen...';
        downloadBtn.disabled = true;

        // A√±adimos un timeout para evitar que se quede "pegado" indefinidamente
        const generationTimeout = setTimeout(() => {
          downloadBtn.textContent = 'Descargar Comprobante';
          downloadBtn.disabled = false;
          alert('La generaci√≥n de la imagen tard√≥ demasiado. Es posible que est√©s abriendo el archivo localmente. Por favor, usa un servidor web o toma una captura de pantalla manualmente.');
        }, 10000); // 10 segundos


        // Usamos html2canvas para "fotografiar" el div del comprobante
        html2canvas(successBox, {
          backgroundColor: '#000', // Fondo negro para la captura
          scale: 2, // Aumenta la resoluci√≥n de la imagen
          useCORS: true // Permite cargar im√°genes de otros dominios (como el fondo)
        }).then(canvas => {
          clearTimeout(generationTimeout); // Si funciona, cancelamos el timeout

          // Creamos un enlace temporal para la descarga
          const link = document.createElement('a');
          link.download = `comprobante-creativos-rp-${orderID || username}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click(); // Simulamos un clic para iniciar la descarga

          // Restauramos el bot√≥n
          downloadBtn.textContent = 'Descargar Comprobante';
          downloadBtn.disabled = false;
        }).catch((error) => {
            clearTimeout(generationTimeout); // Si falla, tambi√©n cancelamos el timeout

            console.error('Error al generar el comprobante:', error);
            alert('Hubo un error al generar la imagen. Por favor, toma una captura de pantalla manualmente.');
            downloadBtn.textContent = 'Descargar Comprobante';
            downloadBtn.disabled = false;
        });
      });
    });
  </script>
</body>
</html>
