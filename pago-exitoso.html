<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¡Pago Exitoso! - Creativos RP</title>
  <link rel="icon" href="logos/logo-gta-san-andreas.jpg" type="image/jpeg">

  <!-- Fuentes y estilos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="styles.css">

  <!-- Ya no se necesita la librería html2canvas -->
  <script defer src="utils.js"></script> <!-- Archivo de utilidades compartidas -->

  <style>
    /* Estilos específicos para esta página de éxito */
    .success-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 2rem;
    }
    .success-box {
      max-width: 600px;
    }
    .success-box .gta-section-title {
        color: #32CD32; /* Verde para éxito */
        text-shadow: 0 0 8px rgba(50, 205, 50, 0.5);
    }
    .receipt-table {
      width: 100%;
      margin-top: 1rem; /* Reducido */
      text-align: left;
      border-collapse: collapse;
    }
    .receipt-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #444;
      color: #fff;
    }
    .receipt-table td:first-child {
      color: #FFD700;
      font-weight: bold;
    }
    .receipt-table tr:last-child td {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div id="gta-bg" aria-hidden="true"></div>

  <main class="success-container">
    <div class="success-box gta-section">
      <h1 class="gta-section-title">¡Transacción Aprobada!</h1>
      <p id="intro-text" class="gta-text" style="margin-bottom: 1rem;">
        Gracias por tu compra, <strong id="display-username">jugador</strong>.
      </p>

      <!-- Tabla de detalles de la compra -->
      <table class="receipt-table" style="margin-bottom: 0.5rem;">
        <tbody>
          <tr><td>Usuario SA-MP:</td><td id="receipt-username">--</td></tr>
          <tr><td>Producto:</td><td id="receipt-item">--</td></tr>
          <tr><td>Monto Pagado:</td><td id="receipt-amount">--</td></tr>
          <tr><td>Fecha del Pago:</td><td id="receipt-date">--</td></tr>
          <tr>
            <td>ID de Transacción:</td>
            <td style="display: flex; justify-content: space-between; align-items: center;">
              <span id="receipt-orderID">--</span>
              <button id="copy-order-id-btn" class="gta-boton-copiar" style="display: none;">Copiar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- NUEVO: Pasos para recibir Coins mostrados en la página -->
      <p class="gta-text" style="text-align: left; display: inline-block; margin-top: 1rem; font-size: 0.9em;">
        <strong id="steps-title-page" style="color: #FFD700;"></strong><br>
        1. Descarga este recibo usando el botón de abajo.<br>
        2. Únete a nuestro Discord y abre un ticket.<br>
        3. Envía el recibo descargado al Staff para validar tu compra.
      </p>
      <div class="gta-button-group" style="margin-top: 1rem;">
        <button id="download-receipt-btn" class="gta-boton">Descargar Comprobante</button>
        <a href="https://discord.gg/EsgBcUCubQ" target="_blank" class="gta-boton">Ir a Discord</a>
        <a href="index.html" class="gta-boton">Volver al Inicio</a>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadDynamicBackground(); // Usamos la función compartida desde utils.js

      const successBox = document.querySelector('.success-box');
      const urlParams = new URLSearchParams(window.location.search);
      
      // Extraemos todos los datos de la URL
      const username = urlParams.get('username');
      const itemName = urlParams.get('itemName');
      const amount = urlParams.get('amount');
      const currency = urlParams.get('currency');
      const dateStr = urlParams.get('date');
      const orderID = urlParams.get('orderID');
      const promoCode = urlParams.get('promoCode'); // Leemos el código promocional
      const paymentMethod = urlParams.get('paymentMethod'); // Leemos el método de pago

      // Lógica para evitar notificaciones duplicadas en Discord
      const notificationKey = `notified_${orderID}`;
      if (orderID && !localStorage.getItem(notificationKey)) {
        fetch(`${API_URL}/log-purchase`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            itemName: itemName,
            amount: amount,
            currency: currency,
            orderID: orderID,
            promoCode: promoCode // Lo enviamos al servidor
          })
        }).then(() => {
          // Si la notificación se procesa, guardamos la marca en localStorage
          localStorage.setItem(notificationKey, 'true');
        }).catch(error => {
          console.error('No se pudo enviar la notificación de compra al servidor:', error);
          // No es un error crítico para el usuario, por lo que no mostramos alerta.
        });
      }

      // --- LÓGICA DE TEXTO DINÁMICO ---
      const isCoinsPurchase = itemName && itemName.toLowerCase().includes('coins');
      const deliveryItemText = isCoinsPurchase ? 'tus Coins' : 'tu producto';
      const stepsTitleText = `Pasos para recibir ${deliveryItemText}:`;

      // Actualiza el texto de introducción
      document.getElementById('intro-text').innerHTML += ` Para recibir ${deliveryItemText}, por favor sigue estos pasos:`;

      // Actualiza el título de los pasos en la página
      document.getElementById('steps-title-page').textContent = stepsTitleText;

      // Mostramos los datos en la página
      document.getElementById('display-username').textContent = username || 'jugador';
      document.getElementById('receipt-username').textContent = username || 'No especificado';
      document.getElementById('receipt-item').textContent = itemName || 'No especificado';
      if (amount && currency) {
        // Formateamos el monto según la moneda recibida
        const formatOptions = {
          style: 'currency',
          currency: currency,
          minimumFractionDigits: currency === 'COP' ? 0 : 2
        };
        const locale = currency === 'COP' ? 'es-CO' : 'en-US';
        document.getElementById('receipt-amount').textContent = new Intl.NumberFormat(locale, formatOptions).format(amount);
      } else {
        document.getElementById('receipt-amount').textContent = 'No especificado';
      }
      document.getElementById('receipt-orderID').textContent = orderID || 'No especificado';

      if (dateStr) {
        // Formateamos la fecha para que sea más legible
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('receipt-date').textContent = date.toLocaleDateString('es-ES', options);
      } else {
        document.getElementById('receipt-date').textContent = 'No especificado';
      }
      
      // Lógica para el botón de copiar ID de transacción
      const copyBtn = document.getElementById('copy-order-id-btn');
      if (orderID) {
        copyBtn.style.display = 'inline-block'; // Muestra el botón si hay un ID
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(orderID).then(() => {
            copyBtn.textContent = '¡Copiado!';
            setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 2000);
          }).catch(() => alert('Error al copiar el ID.'));
        });
      }
      
      // Lógica para descargar el comprobante
      const downloadBtn = document.getElementById('download-receipt-btn');
      downloadBtn.addEventListener('click', () => {
        try {
          // --- ESTRATEGIA FINAL: DIBUJAR MANUALMENTE EN CANVAS ---
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Dimensiones y estilos
          const width = 600; // Ancho de factura
          const padding = 35;
          const lineHeight = 32;
          const lineSpacing = 22;
          const logoSize = 70;

          let currentY = padding;

          // Datos a dibujar
          const data = [
            { label: 'Usuario SA-MP:', value: username || 'No especificado' },
            { label: 'Producto:', value: itemName || 'No especificado' },
            { label: 'Monto Pagado:', value: document.getElementById('receipt-amount').textContent },
            { label: 'Método de Pago:', value: paymentMethod || 'No especificado' },
            { label: 'Fecha del Pago:', value: document.getElementById('receipt-date').textContent },
            { label: 'ID de Transacción:', value: orderID || 'No especificado' }
          ];

          let calculatedHeight = 0; // Se calculará dinámicamente
          canvas.width = width;
          canvas.height = height;

          // 1. Dibuja el fondo
          ctx.fillStyle = '#1a1a1a';
          ctx.fillRect(0, 0, width, height);

          // Función principal para dibujar todo el recibo
          const drawReceipt = () => {
            let currentY = padding;

            // 1. Dibuja el fondo
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, calculatedHeight);

            // 2. Dibuja el borde
            ctx.strokeStyle = '#FF8C00';
            ctx.lineWidth = 4;
            ctx.strokeRect(0, 0, width, calculatedHeight);

            // 3. Dibuja el logo y nombre del servidor
            ctx.drawImage(logo, padding, currentY, logoSize, logoSize);
            ctx.font = "bold 36px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#FFFFFF';
            ctx.textAlign = 'left';
            ctx.fillText('Creativos RP', padding + logoSize + 20, currentY + 45);
            currentY += logoSize + lineSpacing;

            // Línea divisoria del encabezado
            ctx.beginPath();
            ctx.moveTo(padding, currentY);
            ctx.lineTo(width - padding, currentY);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            ctx.stroke();
            currentY += lineSpacing + lineHeight;

            // Dibuja el título del recibo
            ctx.font = "bold 40px 'Permanent Marker', cursive";
            ctx.fillStyle = '#32CD32';
            ctx.textAlign = 'center';
            ctx.fillText('RECIBO DE PAGO', width / 2, currentY);
            currentY += 70;

            // Dibuja los detalles de la transacción
            ctx.textAlign = 'left';
            // "Facturado a:"
            ctx.font = "24px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#aaa';
            ctx.fillText('Facturado a:', padding, currentY);
            ctx.font = "bold 26px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(username || 'No especificado', padding, currentY + lineHeight);
            currentY += 90;

            // --- SOLUCIÓN AL SOLAPAMIENTO DE TEXTO ---
            ctx.font = "bold 26px 'Rajdhani', sans-serif"; // Set font for measurement
            const labelWidths = data.map(item => ctx.measureText(item.label).width);
            const maxLabelWidth = Math.max(...labelWidths);
            const valueColumnX = padding + maxLabelWidth + 25; // Posición X para la columna de valores

            // Dibuja la tabla de detalles
            data.forEach((item) => {
              // Dibuja la etiqueta
              ctx.font = "bold 26px 'Rajdhani', sans-serif";
              ctx.fillStyle = '#FFD700';
              ctx.fillText(item.label, padding, currentY);

              // Dibuja el valor en la columna alineada
              ctx.font = "26px 'Rajdhani', sans-serif";
              ctx.fillStyle = '#FFFFFF';
              ctx.fillText(item.value, valueColumnX, currentY);

              currentY += lineHeight + lineSpacing;
            });

            // --- Dibuja los pasos para recibir los Coins ---
            currentY += lineSpacing * 2; // Espacio antes de los pasos
            ctx.font = "bold 24px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#FFD700';
            ctx.textAlign = 'left';
            ctx.fillText(stepsTitleText, padding, currentY); // Usamos el título dinámico
            currentY += lineHeight;

            ctx.font = "22px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText('1. Descarga este recibo.', padding + 10, currentY); // Redacción actualizada
            currentY += lineHeight;
            ctx.fillText('2. Únete a nuestro Discord y abre un ticket.', padding + 10, currentY);
            currentY += lineHeight;
            ctx.fillText('3. Envía el recibo descargado al Staff para validar tu compra.', padding + 10, currentY); // Redacción actualizada
            currentY += lineHeight;

            // Dibuja el pie de página
            ctx.beginPath();
            ctx.moveTo(padding, calculatedHeight - 80);
            ctx.lineTo(width - padding, calculatedHeight - 80);
            ctx.stroke();
            ctx.font = "20px 'Rajdhani', sans-serif";
            ctx.fillStyle = '#aaa';
            ctx.textAlign = 'center';
            ctx.fillText('Gracias por su compra - Creativos RP', width / 2, calculatedHeight - 45);

            // Inicia la descarga
            const link = document.createElement('a');
            link.download = `comprobante-creativos-rp-${orderID || username}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
          }; // Fin de drawReceipt

          // --- Lógica de carga del logo y cálculo de altura ---
          const logo = new Image();
          logo.src = 'logos/logo-gta-san-andreas.jpg'; // Asegúrate que este logo exista
          logo.onload = () => {
            // Primero, calculamos la altura total que necesitará el canvas
            let tempY = padding;
            tempY += logoSize + lineSpacing; // Logo y nombre
            tempY += lineSpacing + lineHeight; // Divisor
            tempY += 70; // Título
            tempY += 90; // Facturado a
            tempY += data.length * (lineHeight + lineSpacing); // Detalles de la transacción
            tempY += lineSpacing * 2; // Espacio antes de pasos
            tempY += lineHeight; // Título de pasos
            tempY += 3 * lineHeight; // Los 3 pasos
            tempY += lineHeight; // Espacio después de pasos
            tempY += 90; // Pie de página
            calculatedHeight = tempY;

            canvas.height = calculatedHeight; // Establecemos la altura final
            drawReceipt(); // Ahora sí, dibujamos todo
          };
          
          // Manejo de error si el logo no carga
          logo.onerror = () => {
            alert('No se pudo cargar el logo para el comprobante, pero la descarga continuará.');
            // Si el logo falla, calculamos la altura y dibujamos sin él
            let tempY = padding;
            tempY += logoSize + lineSpacing; // Espacio que ocuparía el logo
            tempY += lineSpacing + lineHeight; // Divisor
            tempY += 70; // Título
            tempY += 90; // Facturado a
            tempY += data.length * (lineHeight + lineSpacing); // Detalles de la transacción
            tempY += lineSpacing * 2; // Espacio antes de pasos
            tempY += lineHeight; // Título de pasos
            tempY += 3 * lineHeight; // Los 3 pasos
            tempY += lineHeight; // Espacio después de pasos
            tempY += 90; // Pie de página
            calculatedHeight = tempY;
            canvas.height = calculatedHeight;
            drawReceipt();
          };

        } catch (error) {
          console.error('Error fatal al generar el canvas:', error);
          alert('Hubo un error al generar el comprobante. Por favor, toma una captura de pantalla manualmente.');
        }
      });
    });
  </script>
</body>
</html>
